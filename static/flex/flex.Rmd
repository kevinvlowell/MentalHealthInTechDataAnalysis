---
title: "Interactive Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
---

```{r setup, include=FALSE}

library(flexdashboard)
library(tidyverse)
library(plotly)
library(viridis)
library(crosstalk)
library(DT)

combined_all <- read_csv("all_combined_dataset.csv", col_types = cols())
(problems(combined_all))


```


```{r testing, include=FALSE}

lels <- c("1-5", "6-25" ,"26-100" ,"100-500" ,"500-1000","More than 1000")

combined_all %>% select(age, comfortable_discussing_mh_with_supervisors, company_size) %>%
  na.omit() %>% filter(age >= 18, age <= 50) %>% ggplot(aes(x = comfortable_discussing_mh_with_supervisors , y = age, color = factor(company_size, levels = lels) )) +   geom_point(alpha = 0.6, position = "jitter")

combined_all %>% count(year, has_mhd_now, had_mhd_past) %>% na.omit() %>% filter(!has_mhd_now == "Don't Know", !had_mhd_past == "Don't Know") %>% group_by(has_mhd_now, had_mhd_past) %>% mutate(n2 = sum(n))

plot <- combined_all %>% filter(age >= 10, age <= 70, !is.na(had_mhd_past)) %>% ggplot( aes(x = had_mhd_past , y = age, color = gender,
  text = paste("Country: ", country_of_residence))) +
  geom_point(position = "jitter", alpha = 0.5) +
  scale_fill_viridis()+ 
  labs(color= "gender", x = "Have you had a mental health disorder in the past?")
ggplotly(plot, tooltip = "text")

```

Row 
-----------------------------------------------------------------------

### Comfort level in discussing mental health with supervisors vs. Age, colored by Company Size

```{r}
suppressPackageStartupMessages(library(d3scatter))

lels <- c("1-5", "6-25" ,"26-100" ,"100-500" ,"500-1000","More than 1000")
low <- c("1-5", "6-25" ,"26-100")
high <- c("100-500" ,"500-1000","More than 1000")


to_display <- combined_all %>% 
  select(country_of_work,self_employed,had_mhd_past, family_history_of_mhd, employer_has_discussed_mh_formally, 
         age, comfortable_discussing_mh_with_supervisors, company_size) %>%
  mutate(comfort_numeric = ifelse(comfortable_discussing_mh_with_supervisors == "No", 0,
                                  ifelse(comfortable_discussing_mh_with_supervisors == "Maybe", 0.5, 1)))%>%
  filter(age >= 18, age <= 50, !is.na(comfortable_discussing_mh_with_supervisors), !is.na(company_size)) 

shared_dat <- SharedData$new(to_display)

bscols(
  d3scatter(shared_dat, ~jitter(comfort_numeric), ~jitter(age), ~ factor(company_size, levels = lels),  
          width = "100%",
          x_label = "Comfortable discussing mental health with subervisors?", 
          y_label = "Age", x_lim = c(-0.2, 1.3)),
  
  shared_dat %>% 
    datatable(options = list(pageLength = 10) )
  
)



#leaflet(shared_quakes, width = "100%", height = 300) %>%
    #addTiles() %>%
    #addMarkers(),

```


Row{.tabset .tabset-fade}
-----------------------------------------------------------------------
### Combined 2016 and 2018 dataset

```{r}
for_heat <- combined_all %>% 
  mutate(has_mhd_now = ifelse(has_mhd_now == "Possibly", "Maybe", has_mhd_now),
                                    had_mhd_past = ifelse(had_mhd_past == "Possibly", "Maybe", had_mhd_past)) %>% 
  count(year,has_mhd_now, had_mhd_past) %>% 
  na.omit() %>% 
  filter(!has_mhd_now == "Don't Know", !had_mhd_past == "Don't Know") %>%
  arrange(desc(has_mhd_now), desc(had_mhd_past)) %>%
  group_by(has_mhd_now, had_mhd_past) %>% 
  mutate(n_all = sum(n)) %>% ungroup()

fig <- plot_ly(
    x = for_heat$had_mhd_past , y = for_heat$has_mhd_now,
    z = for_heat$n_all , type = "heatmap",
    colors = colorRamp(c("yellow", "red"))) %>% 
   layout( title = "Reports of past vs. Present mental health",
        xaxis = list(title ="Have you had a mental health disorder in the past?"),
         yaxis = list( title = "Do you currently have a mental health disorder?"),
         zaxis = list(title = "Count"))

fig

```

### 2016

```{r}

for_heat16 <- for_heat %>% select(-n_all) %>%  filter(year == 2016)


fig <- plot_ly(
    x = for_heat16$had_mhd_past , 
    y = for_heat16$has_mhd_now,
    z = for_heat16$n , type = "heatmap",
    colors = colorRamp(c("yellow", "red"))) %>% 
  layout(
      xaxis = list(title ="Have you had a mental health disorder in the past?"),
         yaxis = list( title = "Do you currently have a mental health disorder?"),
         zaxis = list(title = "Count"))

fig





```

### 2018

```{r}

for_heat18 <- for_heat %>% select(-n_all) %>% filter(year == 2018)


fig <- plot_ly(
    x = for_heat18$had_mhd_past , 
    y = for_heat18$has_mhd_now,
    z = for_heat18$n , type = "heatmap",
    colors = colorRamp(c("yellow", "red"))) %>% 
   layout(
     xaxis = list(title ="Have you had a mental health disorder in the past?"),
         yaxis = list( title = "Do you currently have a mental health disorder?"),
         zaxis = list(title = "Count"))

fig

```
